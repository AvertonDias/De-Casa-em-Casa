rules_version = '2';

service cloud.firestore {
    match /databases/{database}/documents {

        // --- Funções Auxiliares ---
        function isAuth() {
            return request.auth != null;
        }

        function getUserData(userId) {
            return get(/databases/$(database)/documents/users/$(userId)).data;
        }
            
        function isUserInCongregation(congId) {
            let userData = getUserData(request.auth.uid);
            return userData != null && userData.congregationId == congId;
        }

        function isSameCongregationAsRequestingUser(targetUserId) {
            let currentUserData = getUserData(request.auth.uid);
            let targetUserData = getUserData(targetUserId);
            return currentUserData != null && targetUserData != null && currentUserData.congregationId == targetUserData.congregationId;
        }
            
        function isRole(role) {
            let userData = getUserData(request.auth.uid);
            return userData != null && userData.role == role;
        }
        
        function isAdmin() {
            return isRole('Administrador');
        }
        
        function isDirigente() {
            return isRole('Dirigente');
        }
        
        function isServoTerritorios() {
            return isRole('Servo de Territórios');
        }
        
        function isAjudanteServo() {
            return isRole('Ajudante de Servo de Territórios');
        }

        function isDirigenteOrAdmin() {
            return isDirigente() || isAdmin();
        }
        
        // Permissão para designar e devolver territórios
        function canManageAssignments() {
            return isAjudanteServo() || isServoTerritorios() || isDirigenteOrAdmin();
        }
        
        // Permissão para limpar o progresso do território
        function canResetProgress() {
            return isServoTerritorios() || isDirigenteOrAdmin();
        }
        
        // Permissão para aprovar novos usuários
        function canApproveUsers() {
            return isServoTerritorios() || isDirigenteOrAdmin();
        }

        // Permissão para ver a lista de usuários
        function canListUsers() {
            return isServoTerritorios() || isDirigenteOrAdmin();
        }
        
        // --- Regras da Congregação ---
        match /congregations/{congId} {
            allow read: if isUserInCongregation(congId);
            allow write: if isUserInCongregation(congId) &&
                         (isAdmin() ||
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['totalHouses', 'totalHousesDone']));

            // --- Regras dos Territórios ---
            match /territories/{terrId} {
                allow read: if isUserInCongregation(congId);
                allow create, delete: if isAdmin() && isUserInCongregation(congId);
                
                // Regra de atualização granular para territórios
                allow update: if isUserInCongregation(congId) && (
                    // Admin pode editar tudo
                    isAdmin() ||
                    // Dirigente pode fazer quase tudo
                    isDirigente() ||
                    // Servo de Território: pode gerenciar atribuições e estrutura
                    (isServoTerritorios() && request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['status', 'assignment', 'stats', 'progress', 'lastUpdate', 'lastWorkedAt', 'quadraCount', 'assignmentHistory'])) ||
                    // Ajudante: pode gerenciar atribuições e estrutura
                    (isAjudanteServo() && request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['status', 'assignment', 'lastUpdate', 'lastWorkedAt', 'quadraCount', 'assignmentHistory'])) ||
                    // Publicador (e outros): podem atualizar o progresso e a estrutura (casas/quadras)
                    (request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['stats', 'progress', 'lastUpdate', 'lastWorkedAt', 'quadraCount', 'assignmentHistory']))
                );

                // Subcoleções
                match /quadras/{quadraId} {
                    allow read, write: if isUserInCongregation(congId);
                    match /casas/{casaId} {
                        allow read, write: if isUserInCongregation(congId);
                    }
                }
                match /activityHistory/{activityId} {
                    allow read, create: if isUserInCongregation(congId);
                    allow update, delete: if isUserInCongregation(congId);
                }
            }
        }

        // --- Regras de Usuários ---
        match /users/{userId} {
            allow create: if request.auth.uid == userId;
            allow get: if isAuth() && (request.auth.uid == userId || isSameCongregationAsRequestingUser(userId));
            allow list: if canListUsers();

            // Usuário pode atualizar seu próprio nome e whatsapp
            allow update: if request.auth.uid == userId && 
                request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'whatsapp']);

            // Admin pode atualizar qualquer campo de outro usuário
            allow update: if isAdmin() && isSameCongregationAsRequestingUser(userId);
                
            // Servos, Dirigentes e Admins podem aprovar/rejeitar usuários pendentes
            allow update: if canApproveUsers() && isSameCongregationAsRequestingUser(userId)
                && resource.data.status == 'pendente'
                && (request.resource.data.status == 'ativo' || request.resource.data.status == 'rejeitado')
                && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);

            allow delete: if isAdmin() && request.auth.uid != userId && isSameCongregationAsRequestingUser(userId);

            match /notifications/{notificationId} {
                allow read, update, delete: if request.auth.uid == userId;
                allow create: if request.auth.uid == userId || ( canManageAssignments() && isSameCongregationAsRequestingUser(userId) );
            }
        }

        // --- Outras Coleções ---
        match /feedbacks/{feedbackId} {
            allow create: if isAuth();
            allow read, update, delete: if false; 
        }

        match /resetTokens/{tokenId} {
            allow read, write: if false;
        }
    }
}
